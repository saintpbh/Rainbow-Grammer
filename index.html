<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Rainbow Game</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>

    <div id="game-container">
        <!-- Welcome Modal -->
        <div id="welcome-modal">
            <!-- Content Injected via JS -->
        </div>

        <!-- Transition Modal -->
        <div id="transition-modal">
            <div class="transition-content">
                <h2 id="next-level-title">Next Level</h2>
                <p id="next-level-description">Grammar explanation goes here</p>
                <button class="ready-btn" onclick="proceedToNextLevel()">Yes, Ready! üöÄ</button>
            </div>
        </div>


        <!-- Grammar Tips Modal -->
        <div class="grammar-modal" id="grammar-modal">
            <div class="grammar-modal-content">
                <h2 id="grammar-title">Grammar Pattern</h2>
                <div class="grammar-explanation" id="grammar-explanation"></div>
                <div class="grammar-examples">
                    <h3>Examples:</h3>
                    <ul id="grammar-examples-list"></ul>
                </div>
                <button class="ready-btn" onclick="closeGrammarModal()">Got it! Let's practice üöÄ</button>
            </div>
        </div>

        <!-- Progress Tracking HUD -->
        <div class="progress-hud">
            <div class="day-info" style="justify-content: space-between; align-items: center; width: 100%;">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span id="day-number">Day 1 of 28</span>
                    <span id="week-badge">Week 1</span>
                </div>
                <!-- Integrated Level/Phase Badge -->
                <div style="display: flex; gap: 6px; align-items: center;">
                    <span id="level-btn" class="level-badge" style="font-size: 0.8rem; padding: 4px 8px;">LEVEL
                        1-1</span>
                    <span id="phase-display" style="font-size: 0.7rem; color: #999; font-weight: bold;">READY</span>
                </div>
            </div>
            <div class="sentence-progress">
                <span id="sentence-counter">Sentence 1 of 10</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="audio-controls"
            style="position: fixed; top: 20px; right: 20px; z-index: 999; display: flex; gap: 4px;">
            <button class="speed-btn" onclick="changeSpeed(0.75)">0.75√ó</button>
            <button class="speed-btn active" onclick="changeSpeed(1.0)">1.0√ó</button>
            <button class="speed-btn" onclick="changeSpeed(1.25)">1.25√ó</button>
            <button class="speed-btn" onclick="changeSpeed(1.5)">1.5√ó</button>
        </div>

        <!-- Hidden Score Elements to prevent JS Errors -->
        <span id="score-today" style="display: none;"></span>
        <span id="score-total" style="display: none;"></span>

        <div id="success-overlay">
            <div class="success-badge">PERFECT! +20</div>
        </div>


        <!-- Context Bubble -->
        <div class="context-bubble" id="context-bubble">
            <div class="context-icon">üí°</div>
            <div class="context-content">
                <div class="context-title">When to use</div>
                <div class="context-text" id="context-text"></div>
            </div>
            <div class="context-close" onclick="hideContext()">√ó</div>
        </div>

        <div class="korean-text" id="question-text">
            Loading...
        </div>


        <!-- Error Feedback -->
        <div class="error-feedback" id="error-feedback">
            <div class="feedback-icon">‚ùå</div>
            <div class="feedback-message" id="feedback-message">Not quite right...</div>
            <div class="feedback-hint" id="feedback-hint"></div>
            <button class="try-again-btn" onclick="resetAfterError()">Try Again</button>
        </div>

        <div class="answer-area" id="answer-slot">
            <!-- Selected chunks appear here -->
            <div style="color: #CFD8DC; font-weight: 600;">Tap chunks to build the sentence</div>
        </div>

        <div class="chunk-pool" id="pool-area">
            <!-- Scrambled chunks appear here -->
        </div>

        <div id="float-score-container"></div>

        <div class="keyboard-hints" id="keyboard-hints">
            Tab: Navigate | Enter: Select | Backspace: Undo | Ctrl+Enter: Submit | R: Replay Audio
        </div>
    </div>



    <!-- Practice Mode Button -->
    <button class="practice-mode-btn" onclick="openPracticeMode()">
        üìö Practice Mode
    </button>

    <!-- Practice Mode Modal -->
    <div class="practice-modal" id="practice-modal">
        <div class="practice-modal-content">
            <h2>üìö Practice Mode</h2>
            <p style="color: #666; margin-bottom: 1.5rem;">
                Choose a day to review. You can practice any completed day without affecting your progress.
            </p>
            <div class="day-selector" id="day-selector"></div>
            <div class="practice-buttons">
                <button class="exit-cancel-btn" onclick="closePracticeMode()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Save & Exit Button -->
    <button class="save-exit-btn" onclick="showExitModal()">üíæ ÌïôÏäµ ÎßàÏπòÍ∏∞</button>

    <!-- Exit Confirmation Modal -->
    <div class="exit-modal" id="exit-modal">
        <div class="exit-modal-content">
            <h2>‚ú® Ï¢ãÏùÄ ÌïôÏäµÏù¥ÏóàÏñ¥Ïöî!</h2>
            <p>
                <strong>ÌòÑÏû¨ ÏßÑÌñâ ÏÉÅÌô©Ïù¥ Ï†ÄÏû•Îê©ÎãàÎã§.</strong><br>
                Îã§ÏùåÏóê Ï†ëÏÜçÌïòÏãúÎ©¥ Î∞îÎ°ú Ïù¥Ïñ¥ÏÑú ÌïôÏäµÌï† Ïàò ÏûàÏäµÎãàÎã§.
            </p>
            <div id="exit-info" style="background: #F5F5F5; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem;">
                <div style="font-size: 0.9rem; color: #666;">ÌòÑÏû¨ ÏúÑÏπò</div>
                <div id="exit-progress" style="font-weight: 700; color: var(--primary); margin-top: 0.5rem;"></div>
            </div>
            <div class="exit-modal-buttons">
                <button class="exit-cancel-btn" onclick="closeExitModal()">Í≥ÑÏÜç ÌïôÏäµ</button>
                <button class="exit-confirm-btn" onclick="confirmExit()">Ï†ÄÏû•ÌïòÍ≥† ÎÇòÍ∞ÄÍ∏∞</button>
            </div>
        </div>
    </div>

    <button class="test-audio-btn" onclick="testAudio()" title="Test Audio">üîä</button>

    <script type="module">
        // Weekly module paths
        const WEEK_FILES = ['week1.json', 'week2.json', 'week3.json', 'week4.json'];

        // --- Logic & Config ---
        const POINTS_PER_WIN = 20;
        const PRINCIPLES = {
            ACTIVE: "Active Construction",
            LOOP: "Sensory Loop (3x)",
            REVIEW: "Spaced Review"
        };

        // Grammar Tag Mapping
        const ROLE_MAP = {
            "Subject": "S",
            "Verb": "V",
            "Object": "O",
            "Complement": "C",
            "Modifier": "M",
            "Adverb": "Adv",
            "Etc": "..."
        };

        let curriculum = [];
        let totalScore = 0;
        let todayScore = 0;

        let currentItem = null;
        let currentChunks = [];
        let selectedIndices = [];
        let currentLevelGlobalIndex = 0;

        // --- Persistence ---
        const SAVE_KEY = "grammar_rainbow_v2"; // Migrated version

        function saveProgress() {
            const state = {
                levelIndex: currentLevelGlobalIndex,
                totalScore: totalScore,
                todayScore: todayScore,
                lastPlayedDate: new Date().toDateString(),
                hasStarted: true
            };
            localStorage.setItem(SAVE_KEY, JSON.stringify(state));
        }

        function loadProgress() {
            const raw = localStorage.getItem(SAVE_KEY);
            if (!raw) return null;
            return JSON.parse(raw);
        }

        function showWelcomeModal() {
            const modal = document.getElementById('welcome-modal');
            const saved = loadProgress();

            let html = '';

            if (saved && saved.hasStarted) {
                // Determine if new day
                const todayStr = new Date().toDateString();
                if (saved.lastPlayedDate !== todayStr) {
                    // New Day Logic
                    saved.todayScore = 0;
                }

                // Initial Load for variables
                currentLevelGlobalIndex = saved.levelIndex || 0;
                totalScore = saved.totalScore || 0;
                todayScore = saved.todayScore || 0;

                html = `
                    <div class="welcome-content">
                        <h1>Welcome Back! üëã</h1>
                        <p>Detailed status report for your session:</p>
                        <div class="principles-grid" style="grid-template-columns:1fr 1fr; max-width:400px; margin: 0 auto 2rem;">
                            <div class="p-card" style="text-align:center;">
                                <span>Total Score</span>
                                <strong style="font-size:1.4rem; color:#FFEA00;">${totalScore}</strong>
                            </div>
                             <div class="p-card" style="text-align:center;">
                                <span>Today's Score</span>
                                <strong style="font-size:1.4rem; color:#00E676;">${todayScore}</strong>
                            </div>
                        </div>
                         <div style="margin-bottom: 20px; font-weight:bold; color: #555;">Current Level: ${currentLevelGlobalIndex + 1}</div>
                        <button class="start-btn" onclick="startGame()">Resume Journey ‚ñ∂</button>
                    </div>
                `;
            } else {
                // First Time User
                html = `
                    <div class="welcome-content">
                        <h1>Rainbow Grammar üåà</h1>
                        <p>Master English grammar through <strong>Colors</strong>, <strong>Patterns</strong>, and <strong>Active Recall</strong>.</p>
                        
                        <div class="color-legend">
                            <div class="legend-dot"><span class="dot" style="background:#FF1744"></span> Subject</div>
                            <div class="legend-dot"><span class="dot" style="background:#FF9100"></span> Verb</div>
                            <div class="legend-dot"><span class="dot" style="background:#00E676"></span> Object</div>
                        </div>

                        <div class="principles-grid">
                            <div class="p-card">
                                <strong>Active Recall</strong>
                                <span>Build sentences yourself.</span>
                            </div>
                            <div class="p-card">
                                <strong>Sensory Loop</strong>
                                <span>Listen 3x to reinforce.</span>
                            </div>
                        </div>
                        
                        <button class="start-btn" onclick="startGame()">Start Learning üöÄ</button>
                    </div>
                `;
            }

            modal.innerHTML = html;
        }

        window.startGame = () => {
            const modal = document.getElementById('welcome-modal');
            modal.classList.add('hidden');
            if (audioCtx.state === 'suspended') audioCtx.resume();

            updateScoreHUD(false); // Sync loaded score
            loadLevel();
        };

        // --- Audio ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSuccessSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(523.25, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        function playFailureSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }


        async function speakSequence(text) {
            // Repeat 3 times for sensory loop
            for (let i = 0; i < 3; i++) {
                await speakText(text);
                if (i < 2) await new Promise(r => setTimeout(r, 300));
            }
        }


        function speakText(text) {
            return new Promise((resolve) => {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);

                // Try to use a better voice if available
                const voices = window.speechSynthesis.getVoices();
                const enVoice = voices.find(v => v.lang.startsWith('en-US')) || voices.find(v => v.lang.startsWith('en'));
                if (enVoice) utterance.voice = enVoice;

                utterance.rate = speechRate || 1.0;
                utterance.onend = resolve;
                utterance.onerror = resolve;
                window.speechSynthesis.speak(utterance);
            });
        }

        // Practice Mode functions
        let isPracticeMode = false;
        let practiceStartIndex = 0;

        function openPracticeMode() {
            const currentDay = Math.floor(currentLevelGlobalIndex / 10) + 1;
            const selector = document.getElementById('day-selector');
            if (!selector) return;

            selector.innerHTML = '';

            for (let day = 1; day <= 28; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day-option';

                if (day <= currentDay) {
                    dayDiv.classList.add('completed');
                    dayDiv.innerHTML = `
                        <div class="day-number">Day ${day}</div>
                        <div class="day-status">${day === currentDay ? 'Current' : '‚úì Review'}</div>
                    `;
                    dayDiv.onclick = () => startPracticeDay(day);
                } else {
                    dayDiv.classList.add('locked');
                    dayDiv.innerHTML = `
                        <div class="day-number">Day ${day}</div>
                        <div class="day-status">üîí Locked</div>
                    `;
                }

                selector.appendChild(dayDiv);
            }

            document.getElementById('practice-modal').classList.add('active');
        }

        function closePracticeMode() {
            const modal = document.getElementById('practice-modal');
            if (modal) modal.classList.remove('active');
        }

        function startPracticeDay(day) {
            isPracticeMode = true;
            practiceStartIndex = (day - 1) * 10;
            const savedIndex = currentLevelGlobalIndex;

            currentLevelGlobalIndex = practiceStartIndex;
            closePracticeMode();
            loadLevel();

            document.getElementById('level-btn').textContent = `üìö Practice: Day ${day}`;
            document.getElementById('level-btn').style.background = '#9C27B0';

            if (!document.getElementById('exit-practice-btn')) {
                const exitBtn = document.createElement('button');
                exitBtn.id = 'exit-practice-btn';
                exitBtn.textContent = '‚Üê Return to Main';
                exitBtn.style.cssText = `
                    position: fixed; top: 80px; right: 20px;
                    background: #424242; color: white;
                    border: none; padding: 10px 20px;
                    border-radius: 20px; cursor: pointer;
                    z-index: 1000; font-weight: 700;
                `;
                exitBtn.onclick = () => exitPracticeMode(savedIndex);
                document.body.appendChild(exitBtn);
            }
        }

        function exitPracticeMode(savedIndex) {
            isPracticeMode = false;
            currentLevelGlobalIndex = savedIndex;
            const exitBtn = document.getElementById('exit-practice-btn');
            if (exitBtn) exitBtn.remove();
            loadLevel();
        }


        window.speechSynthesis.getVoices();

        window.testAudio = () => {
            playSuccessSound();
            speakText("Ready");
        };

        async function speak3x(text) {
            updatePhase(PRINCIPLES.LOOP);
            // Quick 3x loop
            for (let i = 0; i < 3; i++) {
                await speakText(text);
                await new Promise(r => setTimeout(r, 400));
            }
        }

        // --- Core Game ---

        async function loadGame() {
            try {
                // Load all weeks dynamically
                const weekPromises = WEEK_FILES.map(file =>
                    fetch(file)
                        .then(res => res.ok ? res.json() : { curriculum: [] })
                        .catch(() => ({ curriculum: [] }))
                );

                const weeks = await Promise.all(weekPromises);

                // Merge all weeks into single curriculum
                curriculum = [];
                weeks.forEach(week => {
                    if (week.curriculum && week.curriculum.length > 0) {
                        curriculum = curriculum.concat(week.curriculum);
                    }
                });

                console.log(`‚úì Loaded ${curriculum.length} sentences from ${WEEK_FILES.length} weeks`);

                if (curriculum.length === 0) {
                    throw new Error('No curriculum data loaded');
                }

                initApp();
            } catch (e) {
                console.error("Failed to load curriculum:", e);
                alert('Failed to load curriculum data. Please refresh.');
            }
        }

        function initApp() {
            showWelcomeModal();
        }

        function loadLevel() {
            if (currentLevelGlobalIndex >= curriculum.length) {
                alert("Course Complete!");
                return;
            }

            currentItem = curriculum[currentLevelGlobalIndex];
            currentChunks = currentItem.chunks;
            selectedIndices = [];

            // UI Updates
            updatePhase(PRINCIPLES.ACTIVE);

            // Text
            document.getElementById('question-text').textContent = currentItem.korean;

            // Badges & Progress
            document.getElementById('level-btn').textContent = currentItem.section.split(':')[0] || "LEVEL";

            // Update Progress HUD
            updateProgressHUD();

            // Show context bubble
            showContext();

            // Show grammar tip if first sentence of day
            showGrammarTip();

            // Clean Zones
            document.getElementById('success-overlay').classList.remove('active');
            const slot = document.getElementById('answer-slot');
            slot.classList.remove('correct');
            slot.classList.remove('shake');
            slot.innerHTML = '<div style="color: #CFD8DC; font-weight: 500; font-size: 0.9rem;">( Tap words to build )</div>';

            renderPool();
            updateScoreHUD(false);
        }

        function updateProgressHUD() {
            // Calculate day (1-28) from global index (0-279)
            const currentDay = Math.floor(currentLevelGlobalIndex / 10) + 1;
            const currentWeek = Math.ceil(currentDay / 7);
            const sentenceInDay = (currentLevelGlobalIndex % 10) + 1;
            const progressPercent = (sentenceInDay / 10) * 100;

            // Update DOM
            document.getElementById('day-number').textContent = `Day ${currentDay} of 28`;
            document.getElementById('week-badge').textContent = `Week ${currentWeek}`;
            document.getElementById('sentence-counter').textContent = `Sentence ${sentenceInDay} of 10`;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
        }



        function showGrammarTip() {
            // Check if this is first sentence of a new day
            const sentenceInDay = (currentLevelGlobalIndex % 10);

            if (sentenceInDay === 0 && currentItem && currentItem.grammarTip) {
                const tip = currentItem.grammarTip;
                document.getElementById('grammar-title').textContent = tip.title || 'Grammar Pattern';
                document.getElementById('grammar-explanation').textContent = tip.explanation || '';

                const examplesList = document.getElementById('grammar-examples-list');
                examplesList.innerHTML = '';
                if (tip.examples) {
                    tip.examples.forEach(ex => {
                        const li = document.createElement('li');
                        li.textContent = ex;
                        examplesList.appendChild(li);
                    });
                }

                document.getElementById('grammar-modal').classList.add('active');
            }
        }



        let currentFocusIndex = -1;
        let availableChunks = [];

        // Learning Analytics
        let learningStats = {
            patternAccuracy: {},
            dailyProgress: [],
            totalAttempts: 0,
            correctAttempts: 0,
            startTime: Date.now()
        };


        let speechRate = 1.0;

        function changeSpeed(rate) {
            speechRate = rate;

            // Update active button - don't rely on event.target
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnRate = parseFloat(btn.textContent.replace('√ó', ''));
                if (Math.abs(btnRate - rate) < 0.01) {
                    btn.classList.add('active');
                }
            });

            localStorage.setItem('audio_speed', rate);
            console.log(`‚úì Audio speed set to ${rate}x`);
        }

        function loadAudioPreference() {
            const saved = localStorage.getItem('audio_speed');
            if (saved) {
                speechRate = parseFloat(saved);
                // Update button state
                document.querySelectorAll('.speed-btn').forEach(btn => {
                    btn.classList.remove('active');
                    const btnRate = parseFloat(btn.textContent.replace('√ó', ''));
                    if (btnRate === parseFloat(saved)) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        function testAudio() {
            const utterance = new SpeechSynthesisUtterance("Testing audio speed.");
            utterance.rate = speechRate;
            utterance.lang = 'en-US';
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        }

        function trackAttempt(isCorrect, pattern) {
            learningStats.totalAttempts++;
            if (isCorrect) learningStats.correctAttempts++;

            // Track pattern-specific accuracy
            if (!learningStats.patternAccuracy[pattern]) {
                learningStats.patternAccuracy[pattern] = {
                    attempts: 0,
                    correct: 0,
                    accuracy: 0
                };
            }

            const patternStats = learningStats.patternAccuracy[pattern];
            patternStats.attempts++;
            if (isCorrect) patternStats.correct++;
            patternStats.accuracy = Math.round((patternStats.correct / patternStats.attempts) * 100);

            // Save to localStorage
            localStorage.setItem('grammar_analytics', JSON.stringify(learningStats));
        }

        function loadAnalytics() {
            const saved = localStorage.getItem('grammar_analytics');
            if (saved) {
                learningStats = JSON.parse(saved);
            }
        }

        function getWeakPatterns() {
            const patterns = Object.entries(learningStats.patternAccuracy)
                .filter(([_, stats]) => stats.attempts >= 3)
                .sort((a, b) => a[1].accuracy - b[1].accuracy)
                .slice(0, 3);
            return patterns;
        }

        function showStatsModal() {
            const weak = getWeakPatterns();
            const overall = learningStats.totalAttempts > 0
                ? Math.round((learningStats.correctAttempts / learningStats.totalAttempts) * 100)
                : 0;

            let weakHtml = '<h3>Areas to Practice:</h3><ul>';
            weak.forEach(([pattern, stats]) => {
                weakHtml += `<li>${pattern}: ${stats.accuracy}% (${stats.correct}/${stats.attempts})</li>`;
            });
            weakHtml += '</ul>';

            alert(`Overall Accuracy: ${overall}%\n\n${weakHtml.replace(/<[^>]*>/g, '\n')}`);
        }


        function initKeyboardNavigation() {
            document.addEventListener('keydown', handleKeyDown);

            // Show hints on first Tab press
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    document.getElementById('keyboard-hints').classList.add('show');
                    setTimeout(() => {
                        document.getElementById('keyboard-hints').classList.remove('show');
                    }, 3000);
                }
            }, { once: true });
        }

        function handleKeyDown(e) {
            // Get all available pills
            availableChunks = Array.from(document.querySelectorAll('#pool-area .word-pill:not(.used)'));

            if (e.key === 'Tab') {
                e.preventDefault();
                navigateChunks(e.shiftKey ? -1 : 1);
            } else if (e.key === 'Enter' && !e.ctrlKey) {
                e.preventDefault();
                if (currentFocusIndex >= 0 && availableChunks[currentFocusIndex]) {
                    availableChunks[currentFocusIndex].click();
                }
            } else if (e.key === 'Backspace' || e.key === 'Delete') {
                e.preventDefault();
                undoLastSelection();
            } else if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                submitAnswer();
            } else if (e.key === 'r' || e.key === 'R') {
                e.preventDefault();
                if (currentItem) {
                    speakSequence(currentItem.english);
                }
            } else if (e.key === 'Escape') {
                closeGrammarModal();
                hideContext();
            }
        }

        function navigateChunks(direction) {
            if (availableChunks.length === 0) return;

            // Remove previous focus
            if (currentFocusIndex >= 0 && availableChunks[currentFocusIndex]) {
                availableChunks[currentFocusIndex].blur();
            }

            // Update index
            currentFocusIndex += direction;
            if (currentFocusIndex < 0) currentFocusIndex = availableChunks.length - 1;
            if (currentFocusIndex >= availableChunks.length) currentFocusIndex = 0;

            // Focus new element
            if (availableChunks[currentFocusIndex]) {
                availableChunks[currentFocusIndex].focus();
                availableChunks[currentFocusIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }



        function trackVocabularyExposure() {
            if (!currentChunks) return;

            currentChunks.forEach(chunk => {
                const word = chunk.text.toLowerCase();

                if (!learningStats.vocabularyExposure[word]) {
                    learningStats.vocabularyExposure[word] = {
                        count: 0,
                        lastSeen: Date.now(),
                        firstSeen: Date.now(),
                        contexts: []
                    };
                }

                const vocab = learningStats.vocabularyExposure[word];
                vocab.count++;
                vocab.lastSeen = Date.now();

                // Track context (what pattern it appeared in)
                if (!vocab.contexts.includes(currentItem.section)) {
                    vocab.contexts.push(currentItem.section);
                }
            });

            // Save to localStorage
            localStorage.setItem('grammar_analytics', JSON.stringify(learningStats));
        }


        function classifyWordCEFR(word) {
            const a1 = ['i', 'you', 'is', 'are', 'the', 'a', 'an', 'cat', 'dog', 'run', 'see', 'eat', 'happy', 'big', 'small', 'sun', 'moon', 'star', 'shine', 'sleep', 'water', 'fire', 'bird', 'tree', 'flower'];
            const a2 = ['because', 'when', 'where', 'how', 'book', 'read', 'write', 'study', 'work', 'play', 'friend', 'house'];

            const lower = word.toLowerCase();
            if (a1.includes(lower)) return 'A1';
            if (a2.includes(lower)) return 'A2';
            return word.length <= 4 ? 'A1' : 'A2';
        }

        function getVocabularyReport() {
            const vocab = learningStats.vocabularyExposure;
            const entries = Object.entries(vocab);

            // Sort by exposure count
            const sorted = entries.sort((a, b) => b[1].count - a[1].count);

            console.log('=== Vocabulary Exposure Report ===');
            console.log(`Total unique words: ${entries.length}`);
            console.log('\nTop 10 most seen words:');
            sorted.slice(0, 10).forEach(([word, data]) => {
                console.log(`  ${word}: ${data.count} times, contexts: ${data.contexts.join(', ')}`);
            });

            return sorted;
        }

        function analyzeError(userAnswer) {
            const correctAnswer = currentChunks;
            const feedback = {
                message: '',
                hint: ''
            };

            // Check word count
            if (selectedIndices.length !== correctAnswer.length) {
                if (selectedIndices.length > correctAnswer.length) {
                    feedback.message = "You have too many words!";
                    feedback.hint = `Remove ${selectedIndices.length - correctAnswer.length} word(s). The sentence needs ${correctAnswer.length} words total.`;
                } else {
                    feedback.message = "You need more words!";
                    feedback.hint = `Add ${correctAnswer.length - selectedIndices.length} more word(s). The sentence needs ${correctAnswer.length} words total.`;
                }
                return feedback;
            }

            // Check each position
            for (let i = 0; i < selectedIndices.length; i++) {
                const selectedIdx = selectedIndices[i];
                const correctIdx = i;

                if (selectedIdx !== correctIdx) {
                    feedback.message = `Check word #${i + 1}`;
                    const correctChunk = correctAnswer[correctIdx];
                    feedback.hint = `Position ${i + 1} should be a ${correctChunk.role} (${correctChunk.text})`;
                    return feedback;
                }
            }

            feedback.message = "Almost there!";
            feedback.hint = "Double-check the order of your words.";
            return feedback;
        }

        function showErrorFeedback(feedback) {
            document.getElementById('feedback-message').textContent = feedback.message;
            document.getElementById('feedback-hint').textContent = feedback.hint;
            document.getElementById('error-feedback').classList.add('active');

            // Auto-hide after 8 seconds
            setTimeout(() => {
                document.getElementById('error-feedback').classList.remove('active');
            }, 8000);
        }

        function resetAfterError() {
            document.getElementById('error-feedback').classList.remove('active');
            // Keep the selected words but allow reordering
        }

        function undoLastSelection() {
            if (selectedIndices.length > 0) {
                selectedIndices.pop();
                renderAnswer();
                renderPool();
            }
        }

        function submitAnswer() {
            checkAnswer();
        }

        function closeGrammarModal() {
            document.getElementById('grammar-modal').classList.remove('active');
        }

        function showContext() {
            if (currentItem && currentItem.context) {
                document.getElementById('context-text').textContent = currentItem.context;
                document.getElementById('context-bubble').classList.add('active');

                // Auto-hide after 6 seconds
                setTimeout(() => {
                    hideContext();
                }, 6000);
            } else {
                // Hide if no context
                hideContext();
            }
        }

        function hideContext() {
            document.getElementById('context-bubble').classList.remove('active');
        }

        function updatePhase(text) {
            document.getElementById('phase-display').textContent = text;
        }

        function renderPool() {
            const pool = document.getElementById('pool-area');
            pool.innerHTML = '';

            const indices = currentChunks.map((_, i) => i);
            shuffle(indices);

            indices.forEach(idx => {
                const chunk = currentChunks[idx];
                const pill = createPill(chunk, idx, false);
                pool.appendChild(pill);
            });
        }

        function createPill(chunk, idx, isSelected) {
            const pill = document.createElement('div');
            pill.className = `word-pill ${isSelected ? 'selected' : 'pool-item'}`;
            if (isSelected) {
                // Apply colors only when selected
                pill.style.backgroundColor = chunk.color;
                if (isLightColor(chunk.color)) pill.classList.add('dark-text');

                // Allow undo
                pill.onclick = () => undoSelection(idx, pill);
            } else {
                // Pool item click
                pill.onclick = () => handleInput(idx, pill);
            }

            pill.dataset.idx = idx;

            // Inner HTML Structure
            const textDiv = document.createElement('div');
            textDiv.className = 'pill-text';
            textDiv.textContent = chunk.text;

            const tagDiv = document.createElement('div');
            tagDiv.className = 'pill-tag';
            tagDiv.textContent = ROLE_MAP[chunk.role] || chunk.role;
            // Tag background is slightly darker version of chunk color or just transparent white overlay
            tagDiv.style.backgroundColor = "rgba(0,0,0,0.1)";

            pill.appendChild(textDiv);
            pill.appendChild(tagDiv);

            return pill;
        }

        function handleInput(idx, el) {
            if (el.classList.contains('used')) return;

            // --- DEFERRED VALIDATION CHANGE ---
            // Always allow adding the chunk, even if wrong order.
            // Just push to selectedIndices and update UI.

            selectedIndices.push(idx);
            el.classList.add('used'); // Hide pool item

            updateAnswerSlot();
            checkCompletion();
        }

        function undoSelection(chunkIdx, pill) {
            // Find where this chunk is in selectedIndices
            const pos = selectedIndices.indexOf(chunkIdx);
            if (pos === -1) return;

            // Remove from selectedIndices
            selectedIndices.splice(pos, 1);

            // Re-enable pool item
            const poolArea = document.getElementById('pool-area');
            const poolItem = poolArea.querySelector(`.word-pill[data-idx="${chunkIdx}"]`);
            if (poolItem) poolItem.classList.remove('used');

            updateAnswerSlot();
        }

        function updateAnswerSlot() {
            const slot = document.getElementById('answer-slot');
            slot.innerHTML = '';
            slot.classList.remove('shake'); // Clear any previous error state

            if (selectedIndices.length === 0) {
                slot.innerHTML = '<div style="color: #CFD8DC; font-weight: 500; font-size: 0.9rem;">( Tap words to build )</div>';
                return;
            }

            selectedIndices.forEach(idx => {
                const chunk = currentChunks[idx];
                const pill = createPill(chunk, idx, true);
                slot.appendChild(pill);
            });
        }

        async function checkCompletion() {
            // Only check when ALL slots are filled
            if (selectedIndices.length === currentChunks.length) {

                // Validate Order
                let isCorrect = true;
                for (let i = 0; i < selectedIndices.length; i++) {
                    // Since chunks are 0-indexed in order, selectedIndices should be [0, 1, 2...]
                    if (selectedIndices[i] !== i) {
                        isCorrect = false;
                        break;
                    }
                }

                if (isCorrect) {
                    // Level Complete
                    totalScore += POINTS_PER_WIN;
                    todayScore += POINTS_PER_WIN;

                    document.getElementById('answer-slot').classList.add('correct');
                    playSuccessSound();
                    updateScoreHUD(true);
                    showFloatingScore();

                    // Success overlay removed per user request
                    // document.getElementById('success-overlay').classList.add('active');

                    // SAVE PROGRESS
                    currentLevelGlobalIndex++;
                    saveProgress();
                    currentLevelGlobalIndex--;

                    // Audio Loop
                    if (currentItem.english) {
                        await speak3x(currentItem.english);
                    } else {
                        await new Promise(r => setTimeout(r, 1500));
                    }

                    // Check if next level is a new section
                    currentLevelGlobalIndex++;
                    const currentSection = currentItem.section;
                    const nextItem = curriculum[currentLevelGlobalIndex];

                    if (nextItem && nextItem.section !== currentSection) {
                        // Sub-level complete! Show celebration
                        showLevelUpCelebration(currentSection, nextItem.section);
                    } else {
                        // Same section, just go to next sentence
                        loadLevel();
                    }

                } else {
                    // --- ERROR STATE ---
                    document.getElementById('answer-slot').classList.add('shake');
                    playFailureSound();
                    // Optional: Auto-reset? Or let user undo? User request implies just shake.
                    // The shake animation runs for 0.4s. User can then click to undo.
                }
            }
        }

        function showLevelUpCelebration(completedSection, nextSection) {
            // Animate the level badge
            const badge = document.getElementById('level-btn');
            badge.classList.add('levelup');
            setTimeout(() => badge.classList.remove('levelup'), 1000);

            // Show transition modal after celebration
            setTimeout(() => {
                showTransitionModal();
            }, 1200);
        }

        function showTransitionModal() {
            if (currentLevelGlobalIndex >= curriculum.length) {
                alert('Course Complete! üéâ');
                return;
            }

            const nextLevel = curriculum[currentLevelGlobalIndex];
            const modal = document.getElementById('transition-modal');

            document.getElementById('next-level-title').textContent = nextLevel.section || 'Next Level';
            document.getElementById('next-level-description').textContent = nextLevel.description || 'Continue your learning journey!';

            modal.classList.add('active');
        }

        window.proceedToNextLevel = () => {
            const modal = document.getElementById('transition-modal');
            modal.classList.remove('active');
            loadLevel();
        }

        function showFloatingScore() {
            const container = document.getElementById('float-score-container');
            const el = document.createElement('div');
            el.className = 'score-anim';
            el.textContent = `+${POINTS_PER_WIN}`;
            el.style.animation = 'floatingScore 0.8s forwards';
            container.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function updateScoreHUD(anim) {
            const todayEl = document.getElementById('score-today');
            const totalEl = document.getElementById('score-total');

            todayEl.textContent = todayScore.toString().padStart(4, '0');
            totalEl.textContent = totalScore.toString().padStart(4, '0');
        }

        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        function isLightColor(hex) {
            // Simple check for Yellow/Lime/Cyan
            const brights = ['#FFFF00', '#00FF00', '#00FFFF', '#76FF03'];
            return brights.includes(hex.toUpperCase());
        }

        // Practice Mode functions

        function showExitModal() {
            const currentDay = Math.floor(currentLevelGlobalIndex / 10) + 1;
            const sentenceInDay = (currentLevelGlobalIndex % 10) + 1;
            const currentWeek = Math.ceil(currentDay / 7);

            document.getElementById('exit-progress').innerHTML = `
                Day ${currentDay} of 28 (Week ${currentWeek})<br>
                Sentence ${sentenceInDay} of 10<br>
                <span style="color: #00BFA5;">Total Score: ${totalScore}</span>
            `;

            document.getElementById('exit-modal').classList.add('active');
        }

        function closeExitModal() {
            document.getElementById('exit-modal').classList.remove('active');
        }

        function confirmExit() {
            saveProgress();
            closeExitModal();

            const container = document.getElementById('game-container');
            container.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <h1 style="font-size: 3rem; margin-bottom: 1rem;">üéâ</h1>
                    <h2 style="color: var(--primary); margin-bottom: 1rem;">ÌïôÏäµÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!</h2>
                    <p style="color: #666; margin-bottom: 2rem; font-size: 1.1rem;">
                        Îã§ÏùåÏóê Ï†ëÏÜçÌïòÏãúÎ©¥<br>
                        <strong style="color: var(--accent);">Day ${Math.floor(currentLevelGlobalIndex / 10) + 1}, Sentence ${(currentLevelGlobalIndex % 10) + 1}</strong>Î∂ÄÌÑ∞<br>
                        Ïù¥Ïñ¥ÏÑú ÌïôÏäµÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§.
                    </p>
                    <button onclick="location.reload()" style="
                        background: var(--primary);
                        color: white;
                        border: none;
                        padding: 16px 32px;
                        border-radius: 30px;
                        font-size: 1.1rem;
                        font-weight: 700;
                        cursor: pointer;
                    ">Îã§Ïãú ÏãúÏûëÌïòÍ∏∞</button>
                </div>
            `;

            if (learningStats) {
                localStorage.setItem('grammar_analytics', JSON.stringify(learningStats));
            }
        }


        // --- Initialization & Global Attachments ---

        // Make functions globally available for HTML onclick handlers
        window.startGame = startGame;
        window.proceedToNextLevel = proceedToNextLevel;
        window.openPracticeMode = openPracticeMode;
        window.closePracticeMode = closePracticeMode;
        window.showExitModal = showExitModal;
        window.closeExitModal = closeExitModal;
        window.confirmExit = confirmExit;
        window.startPracticeDay = startPracticeDay;
        window.exitPracticeMode = exitPracticeMode;
        window.changeSpeed = changeSpeed;
        window.testAudio = testAudio;

        // Start the game
        window.speechSynthesis.getVoices(); // Init voices
        loadGame();
        initKeyboardNavigation();
        loadAnalytics();
        loadAudioPreference();

    </script>
</body>

</html>

</html>